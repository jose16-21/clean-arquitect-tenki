name: CI/CD Pipeline con Tenki

on:
  push:
    branches: [ master, develop ]  # Solo ejecutar en push a master/develop (despuÃ©s de merge)
  pull_request:
    branches: [ master, develop ]  # Ejecutar cuando se abre/actualiza PR

jobs:
  build-and-test:
    # ğŸš€ Usar Tenki runner en lugar de ubuntu-latest
    # Opciones disponibles:
    # - tenki-standard-small-2c-4g (2 vCPU, 4GB RAM)
    # - tenki-standard-medium-4c-8g (4 vCPU, 8GB RAM)
    # - tenki-standard-large-8c-16g (8 vCPU, 16GB RAM)
    # - tenki-standard-large-plus-16c-32g (16 vCPU, 32GB RAM)
    # - tenki-autoscale (escala automÃ¡ticamente segÃºn necesidades)
    runs-on: tenki-standard-medium-4c-8g
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Configurar .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: ğŸ“¦ Restaurar dependencias
      run: dotnet restore
      
    - name: ğŸ”¨ Compilar proyecto
      run: dotnet build --configuration Release --no-restore
      
    - name: ğŸ§ª Ejecutar tests (si existen)
      run: dotnet test --no-build --verbosity normal --configuration Release
      continue-on-error: true
      
    - name: ğŸ“Š Verificar salud de la aplicaciÃ³n
      run: |
        dotnet run --project . --no-build --configuration Release &
        APP_PID=$!
        sleep 10
        curl -f http://localhost:8080/health || exit 1
        kill $APP_PID

  build-docker:
    needs: build-and-test
    runs-on: tenki-standard-medium-4c-8g
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ‹ Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”¨ Build de imagen Docker
      run: |
        docker build -t holamundonet10:${{ github.sha }} .
        docker tag holamundonet10:${{ github.sha }} holamundonet10:latest
        
    - name: ğŸ“Š InformaciÃ³n de la imagen
      run: |
        echo "âœ… Imagen creada exitosamente"
        docker images | grep holamundonet10
        docker inspect holamundonet10:latest --format='TamaÃ±o: {{.Size}}'

  performance-check:
    needs: build-and-test
    runs-on: tenki-standard-autoscale
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Configurar .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: ğŸš€ Benchmark de rendimiento
      run: |
        dotnet build --configuration Release
        echo "ğŸ¯ AplicaciÃ³n compilada y lista para producciÃ³n"
        echo "ğŸ“Š EstadÃ­sticas de compilaciÃ³n:"
        ls -lh bin/Release/net10.0/
